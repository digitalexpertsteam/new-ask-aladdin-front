import { __decorate } from "tslib";
import { Injectable, Injector, ComponentFactoryResolver, EmbeddedViewRef, ApplicationRef } from '@angular/core';
import { EventService } from './event.service';
import { OverlayContainerComponent } from './overlay-container.component';
import { defaultProperties } from './default-properties';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './event.service';
var Overlay = /** @class */ (function () {
    function Overlay(componentFactoryResolver, appRef, injector, eventService) {
        var _this = this;
        this.componentFactoryResolver = componentFactoryResolver;
        this.appRef = appRef;
        this.injector = injector;
        this.eventService = eventService;
        this.componentRefs = {};
        this._properties = {};
        this.globalEventsSubscription = this.eventService.emitter.subscribe(function (event) {
            _this.handleGlobalEvents(event);
        });
    }
    Overlay.prototype.appendComponentToBody = function (properties, component) {
        if (component === void 0) { component = OverlayContainerComponent; }
        //if (this.componentRefs[properties.id]){
        if (this.componentRefs[0]) {
            return;
        }
        var componentRef = this.componentFactoryResolver
            .resolveComponentFactory(component)
            .create(this.injector);
        //this.componentRefs[properties.id] = componentRef;
        this.componentRefs[0] = componentRef;
        componentRef.instance.properties = properties;
        this.appRef.attachView(componentRef.hostView);
        var domElem = componentRef.hostView.rootNodes[0];
        // Add to body
        document.body.appendChild(domElem);
    };
    /*
    appendComponentToTag(element: any, tagname: string = ''):void {
        if (tagname){
            document.getElementsByTagName(tagname)[0].appendChild(element);
        } else {
            document.body.appendChild(element);
        }
    }
    */
    Overlay.prototype.load = function (properties) {
        properties = this.applyPropertieDefaults(defaultProperties, properties);
        this.appendComponentToBody(properties);
    };
    Overlay.prototype.close = function (prop) {
        if (prop === void 0) { prop = {}; }
        /*
        if (this.componentRefs[prop.id]){
            (<ContainerProperties>this.componentRefs[prop.id].instance).closeOverlay();
        }
        */
    };
    Overlay.prototype.applyPropertieDefaults = function (defaultProperties, properties) {
        if (!properties) {
            properties = {};
        }
        if (!properties.index) {
            properties.index = 0;
        }
        this._defaultProperties = Object.assign({}, defaultProperties);
        return Object.assign(this._defaultProperties, properties);
    };
    Overlay.prototype.objectLength = function (obj) {
        var length = 0, key;
        for (key in obj) {
            if (obj.hasOwnProperty(key))
                length++;
        }
        return length;
    };
    ;
    Overlay.prototype.handleGlobalEvents = function (event) {
        if (event.type === '[Overlay] Hide') {
            this.handleCloseEvent();
        }
    };
    Overlay.prototype.handleCloseEvent = function () {
        //const id = 'popover'; // Note: pass id in event
        this.appRef.detachView(this.componentRefs[0].hostView);
        this.componentRefs[0].destroy();
        delete this.componentRefs[0];
    };
    Overlay.ctorParameters = function () { return [
        { type: ComponentFactoryResolver },
        { type: ApplicationRef },
        { type: Injector },
        { type: EventService }
    ]; };
Overlay.ɵfac = function Overlay_Factory(t) { return new (t || Overlay)(ɵngcc0.ɵɵinject(ɵngcc0.ComponentFactoryResolver), ɵngcc0.ɵɵinject(ɵngcc0.ApplicationRef), ɵngcc0.ɵɵinject(ɵngcc0.Injector), ɵngcc0.ɵɵinject(ɵngcc1.EventService)); };
Overlay.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: Overlay, factory: function (t) { return Overlay.ɵfac(t); } });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(Overlay, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc0.ComponentFactoryResolver }, { type: ɵngcc0.ApplicationRef }, { type: ɵngcc0.Injector }, { type: ɵngcc1.EventService }]; }, null); })();
    return Overlay;
}());
export { Overlay };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3ZlcmxheS5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyJhbmd1bGFyLWdhbGxlcnkvbGliL292ZXJsYXkvb3ZlcmxheS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSx3QkFBd0IsRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRWhILE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUUxRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7O0FBR3pEO0FBQ3FCLElBS2pCLGlCQUNZLHdCQUFrRCxFQUNsRCxNQUFzQixFQUN0QixRQUFrQixFQUNsQixZQUEwQjtBQUN6QyxRQUxHLGlCQVVDO0FBRUwsUUFYZ0IsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtBQUNsRSxRQUFnQixXQUFNLEdBQU4sTUFBTSxDQUFnQjtBQUN0QyxRQUFnQixhQUFRLEdBQVIsUUFBUSxDQUFVO0FBQ2xDLFFBQWdCLGlCQUFZLEdBQVosWUFBWSxDQUFjO0FBQUUsUUFSeEMsa0JBQWEsR0FBRyxFQUFFLENBQUM7QUFDdEIsUUFBRyxnQkFBVyxHQUFRLEVBQUUsQ0FBQztBQUN6QixRQU9PLElBQUksQ0FBQyx3QkFBd0IsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQy9ELFVBQUMsS0FBSztBQUFLLFlBQ1AsS0FBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzlDLFFBQVcsQ0FBQyxDQUNKLENBQUM7QUFDVCxJQUFHLENBQUM7QUFFTCxJQUFJLHVDQUFxQixHQUFyQixVQUFzQixVQUFlLEVBQUUsU0FBMEM7QUFBSyxRQUEvQywwQkFBQSxFQUFBLHFDQUEwQztBQUFLLFFBQ2xGLHlDQUF5QztBQUNoRCxRQUFP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QUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFFQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUVBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFFQSxBQVFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFJQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQ0EsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFyRkEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQVZBLEFBQUEsQUFEQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBNkZBLEFBQUEsQUFBQSxBQUFBLEFBN0ZBLEFBNkZBLEFBN0ZBLEFBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBFbWJlZGRlZFZpZXdSZWYsIEFwcGxpY2F0aW9uUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IEV2ZW50U2VydmljZSB9IGZyb20gJy4vZXZlbnQuc2VydmljZSc7XG5pbXBvcnQgeyBPdmVybGF5Q29udGFpbmVyQ29tcG9uZW50IH0gZnJvbSAnLi9vdmVybGF5LWNvbnRhaW5lci5jb21wb25lbnQnO1xuaW1wb3J0IHsgT3ZlcmxheVByb3BlcnRpZXMsIENvbnRhaW5lclByb3BlcnRpZXMgfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgZGVmYXVsdFByb3BlcnRpZXMgfSBmcm9tICcuL2RlZmF1bHQtcHJvcGVydGllcyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBPdmVybGF5IHtcbiAgICBnbG9iYWxFdmVudHNTdWJzY3JpcHRpb247XG4gICAgY29tcG9uZW50UmVmcyA9IHt9O1xuICAgIF9wcm9wZXJ0aWVzOiBhbnkgPSB7fTtcbiAgICBfZGVmYXVsdFByb3BlcnRpZXM6IGFueTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgICAgICBwcml2YXRlIGFwcFJlZjogQXBwbGljYXRpb25SZWYsXG4gICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgICAgICBwcml2YXRlIGV2ZW50U2VydmljZTogRXZlbnRTZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMuZ2xvYmFsRXZlbnRzU3Vic2NyaXB0aW9uID0gdGhpcy5ldmVudFNlcnZpY2UuZW1pdHRlci5zdWJzY3JpYmUoXG4gICAgICAgICAgICAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUdsb2JhbEV2ZW50cyhldmVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgYXBwZW5kQ29tcG9uZW50VG9Cb2R5KHByb3BlcnRpZXM6IGFueSwgY29tcG9uZW50OiBhbnkgPSBPdmVybGF5Q29udGFpbmVyQ29tcG9uZW50KTp2b2lkIHtcbiAgICAgICAgLy9pZiAodGhpcy5jb21wb25lbnRSZWZzW3Byb3BlcnRpZXMuaWRdKXtcbiAgICAgICAgaWYgKHRoaXMuY29tcG9uZW50UmVmc1swXSl7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjb21wb25lbnRSZWYgPSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlclxuICAgICAgICAgICAgLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGNvbXBvbmVudClcbiAgICAgICAgICAgIC5jcmVhdGUodGhpcy5pbmplY3Rvcik7XG5cbiAgICAgICAgLy90aGlzLmNvbXBvbmVudFJlZnNbcHJvcGVydGllcy5pZF0gPSBjb21wb25lbnRSZWY7XG4gICAgICAgIHRoaXMuY29tcG9uZW50UmVmc1swXSA9IGNvbXBvbmVudFJlZjtcblxuICAgICAgICAoPENvbnRhaW5lclByb3BlcnRpZXM+Y29tcG9uZW50UmVmLmluc3RhbmNlKS5wcm9wZXJ0aWVzID0gcHJvcGVydGllcztcbiAgICAgICAgdGhpcy5hcHBSZWYuYXR0YWNoVmlldyhjb21wb25lbnRSZWYuaG9zdFZpZXcpO1xuICAgICAgICBjb25zdCBkb21FbGVtID0gKGNvbXBvbmVudFJlZi5ob3N0VmlldyBhcyBFbWJlZGRlZFZpZXdSZWY8YW55Pikucm9vdE5vZGVzWzBdIGFzIEhUTUxFbGVtZW50O1xuXG4gICAgICAgIC8vIEFkZCB0byBib2R5XG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZG9tRWxlbSk7XG4gICAgfVxuXG4gICAgLypcbiAgICBhcHBlbmRDb21wb25lbnRUb1RhZyhlbGVtZW50OiBhbnksIHRhZ25hbWU6IHN0cmluZyA9ICcnKTp2b2lkIHtcbiAgICAgICAgaWYgKHRhZ25hbWUpe1xuICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnbmFtZSlbMF0uYXBwZW5kQ2hpbGQoZWxlbWVudCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgfVxuICAgICovXG5cbiAgICBwdWJsaWMgbG9hZChwcm9wZXJ0aWVzOiBPdmVybGF5UHJvcGVydGllcyk6dm9pZCB7XG4gICAgICAgIHByb3BlcnRpZXMgPSB0aGlzLmFwcGx5UHJvcGVydGllRGVmYXVsdHMoZGVmYXVsdFByb3BlcnRpZXMsIHByb3BlcnRpZXMpO1xuICAgICAgICB0aGlzLmFwcGVuZENvbXBvbmVudFRvQm9keShwcm9wZXJ0aWVzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2xvc2UocHJvcDogYW55ID0ge30pOnZvaWQge1xuICAgICAgICAvKlxuICAgICAgICBpZiAodGhpcy5jb21wb25lbnRSZWZzW3Byb3AuaWRdKXtcbiAgICAgICAgICAgICg8Q29udGFpbmVyUHJvcGVydGllcz50aGlzLmNvbXBvbmVudFJlZnNbcHJvcC5pZF0uaW5zdGFuY2UpLmNsb3NlT3ZlcmxheSgpO1xuICAgICAgICB9XG4gICAgICAgICovXG4gICAgfVxuXG4gICAgYXBwbHlQcm9wZXJ0aWVEZWZhdWx0cyhkZWZhdWx0UHJvcGVydGllcywgcHJvcGVydGllcyl7XG4gICAgICAgIGlmICghcHJvcGVydGllcykge1xuICAgICAgICAgICAgcHJvcGVydGllcyA9IHt9O1xuICAgICAgICB9XG4gICAgICAgIGlmICghcHJvcGVydGllcy5pbmRleCl7IFxuICAgICAgICAgICAgcHJvcGVydGllcy5pbmRleCA9IDA7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fZGVmYXVsdFByb3BlcnRpZXMgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0UHJvcGVydGllcyk7XG4gICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHRoaXMuX2RlZmF1bHRQcm9wZXJ0aWVzLCBwcm9wZXJ0aWVzKTtcbiAgICB9XG5cbiAgICBvYmplY3RMZW5ndGgob2JqKTpudW1iZXIge1xuICAgICAgICBsZXQgbGVuZ3RoID0gMCwga2V5O1xuICAgICAgICBmb3IgKGtleSBpbiBvYmopIHtcbiAgICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgbGVuZ3RoKys7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGxlbmd0aDtcbiAgICB9O1xuXG4gICAgaGFuZGxlR2xvYmFsRXZlbnRzKGV2ZW50KXtcbiAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICdbT3ZlcmxheV0gSGlkZScpe1xuICAgICAgICAgICAgdGhpcy5oYW5kbGVDbG9zZUV2ZW50KCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBoYW5kbGVDbG9zZUV2ZW50KCl7XG4gICAgICAgIC8vY29uc3QgaWQgPSAncG9wb3Zlcic7IC8vIE5vdGU6IHBhc3MgaWQgaW4gZXZlbnRcbiAgICAgICAgdGhpcy5hcHBSZWYuZGV0YWNoVmlldyh0aGlzLmNvbXBvbmVudFJlZnNbMF0uaG9zdFZpZXcpO1xuICAgICAgICB0aGlzLmNvbXBvbmVudFJlZnNbMF0uZGVzdHJveSgpO1xuICAgICAgICBkZWxldGUgdGhpcy5jb21wb25lbnRSZWZzWzBdO1xuICAgIH1cbn0iXX0=